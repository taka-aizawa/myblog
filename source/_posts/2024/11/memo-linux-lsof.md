---
title: 特定のポートとプロセスについて調べる
date: 2024-11-12 11:27:31
tags: コマンド
category: linux
---

CKANを一旦アンインストールして再インストールしたところ、アンインストール前のユーザ情報・アカウント情報が引き継がれていた。

これらの情報はどこのファイルを参照しているのかと思い、ポートからプロセスを確認すればよい？？と思いつき、調べ方を確認してみた。

参考にさせていただいたサイトはこちら。
- [lsofコマンド入門](https://qiita.com/hypermkt/items/905139168b0bc5c28ef2)
- [lsofを使ってプロセスが利用しているポートを確認する。](https://qiita.com/kooohei/items/9e3859e3d1d854c3d163)

ただ、実際はlsofコマンドを使う必要はなくて、CKANのファイルやディレクトリ構造を調べれば良いだけだった。初心者の回り道ハズカシイ。。。

<br>

---
# lsofコマンド
---

特定のポートとプロセスの対応関係を調べるには、lsofコマンドを使用する。
なお、「lsof」は「list open files」の略とのこと（Wikipedia調べ）。

<br>

---
# 調べてみる
---

`localhost:5000`のプロセスを調べてみる。
（「いやCKANって最初から判っているやん！」というツッコミは後ほど理解した。）

<br>

### <u>ポート5000のプロセスを特定</u>

「-i:ポート番号」オプションで、指定したポート番号で実行中のプロセスが表示される。

~~~
$ sudo lsof -i:5000
~~~
<br>

上記の出力を見ると、5000番ポートで実行されているプロセスのID（PID）が表示される。
今回のPIDは410879だった。

<br>

### <u>出力結果のPIDから、プロセスがアクセルしているファイルを調べる</u>

このPIDをキーにして、プロセスがアクセスしているファイルやディレクトリを確認する。

「-p」オプションでPIDを指定すると、そのプロレスがアクセスしているファイルが表示できる。

~~~
$ sudo lsof -p 410879

COMMAND      PID USER   FD      TYPE    DEVICE SIZE/OFF      NODE NAME
docker-pr 410879 root  cwd       DIR     253,0      224       128 /
docker-pr 410879 root  rtd       DIR     253,0      224       128 /
...
~~~
<br>

### <u>そういえばDockerでCKAN動かしてたわ、、、</u>

表示内容を見てみると、410879のプロセスはdocker-proxyコマンドで実行されている。つまり、DockerがCKANのプロセスを`localhost:5000`にポートフォワーディングしている。

と、ここまで作業してみて、

- そういえばCKANをDockerで実行してたやん、、、
- 知りたいのはCKAN内部の参照ファイルなんだから、わざわざポート番号からプロセスを特定しなくてもCKANがユーザ情報やグループ情報を格納しているファイルやディレクトリを調べれば良いやん、、、

と思い至る。

<br>

### <u>Chat-GPTに聞いてみる</u>

> Q. CKANの内部フォルダの中で、ユーザグループ情報を格納しているフォルダの名前は何か？

> A. CKANでは、ユーザグループ情報は主にデータベースに格納されており、特定のフォルダに保存されているわけではありません。ただし、コードやテンプレート、設定ファイルにアクセスしたい場合は、以下のディレクトリが関係しています。
> 
> **主に関係するディレクトリ**
> 1. ckan/model
> model ディレクトリには CKAN の ORM モデル（データベースとのやり取りの仕組み）が含まれています。group.py ファイルには、ユーザグループ（オーガナイゼーションやグループ）のデータ構造が定義されています。
> 
> 2. ckan/logic/action
> action ディレクトリには、グループに関連する API やロジックが含まれており、group.py や > organization.py でユーザグループや組織の操作が実装されています。
> 
> 3. ckan/templates
> templates フォルダには、ユーザーやグループ情報を表示する HTML テンプレートが含まれており、特に group または organization サブディレクトリが関連するテンプレートです。
> 
> **データベースとの関連**
> CKAN では、ユーザ、グループ、組織などの情報は PostgreSQL データベース内に格納されます。ユーザグループに関する情報は、主に以下のようなテーブルに保存されています。
> 
> group テーブル: グループ情報を格納
> member テーブル: ユーザとグループの関係を格納

<br>

> Q. rocky linuxでCKANを一度アンインストールして再度インストールしたところ、アンインストール前のグループ情報等が残っていた。これはなぜか？

> A. CKANをアンインストールしても、設定やデータはデータベースとファイルシステムの別の場所に保存されているため、アンインストール前のデータが残っている可能性があります。以下が考えられる理由です。
> 
> **1.データベースのデータが残っている**
> CKANのデータ（グループ、ユーザ、データセットなど）は、通常 PostgreSQL データベースに保存されています。アンインストールしても、データベース自体やその内容は削除されないため、再インストール時に同じデータベースを参照すると、以前のデータがそのまま残っていることになります。
> 
> 対策：CKAN のデータベースを削除またはリセットするには、次のような PostgreSQL コマンドを使用してデータベースを削除・再作成する必要があります。
> 
> ~~~
> sudo -u postgres dropdb ckan_default
> sudo -u postgres createdb -O ckan_default ckan_default
> ~~~
> 
> **2.storage_path ディレクトリが残っている**
> CKAN の設定ファイル（通常 production.ini）で指定されている storage_path は、ファイルアップロード先のディレクトリです。このフォルダ内には、データセットのファイルやリソースが保存されるため、アンインストールしても削除されません。
> 
> 対策：storage_path のフォルダ（通常 /var/lib/ckan/default など）を手動で削除することで、アップロードされたファイルやキャッシュが削除されます。
> 
> **3. 設定ファイルの残存**
> CKAN の設定ファイル（例：/etc/ckan/default/production.ini）が残っている場合もあります。このファイルにはデータベース接続情報が含まれているため、再インストール後も同じデータベースに接続することになります。
> 
> 対策：production.ini ファイルを確認し、再インストールの際に新しい設定ファイルを作成するか、データベース設定を変更してください。
> 
> このように、アンインストール後にデータベースやファイルシステムに残っているデータが再インストール時に参照されるため、以前のグループ情報などが残っている可能性が高いです。

<br>

### <u>別に問題なさそう</u>

上記の回答で、CKANが参照しているフォルダの場所がわかった（/etc/ckan/default/や/var/lib/ckan/default　など）ので、とりあえず調べるのはここまでにして、何か問題が発生したらもう少し詳しく調べることにした。

<br>

